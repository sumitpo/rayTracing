CMAKE_MINIMUM_REQUIRED(VERSION 3.15)
PROJECT(raytracer-c C)

SET(TARGET raytracer-c)

# set C std
SET(CMAKE_C_STANDARD 99)
SET(CMAKE_C_STANDARD_REQUIRED ON)
SET(CMAKE_C_EXTENSIONS OFF)

# options: whether to build example; skip building example when build as library
OPTION(BUILD_EXAMPLES "Build the raytracer examples" ON)

# 查找 Conan 提供的依赖（由 CMakeDeps 生成） 注意：conan install 会生成 conan_deps.cmake
IF(EXISTS "${CMAKE_BINARY_DIR}/conan_deps.cmake")
  INCLUDE("${CMAKE_BINARY_DIR}/conan_deps.cmake")
ELSEIF(EXISTS "${CMAKE_CURRENT_BINARY_DIR}/conan_deps.cmake")
  INCLUDE("${CMAKE_CURRENT_BINARY_DIR}/conan_deps.cmake")
ENDIF()

# ================
# 库目标
# ================
FILE(GLOB_RECURSE SOURCES "src/*.c")
ADD_LIBRARY(${TARGET} ${SOURCES})

# 设置 include 目录（PUBLIC 表示使用者也需要）
TARGET_INCLUDE_DIRECTORIES(
  ${TARGET}
  PUBLIC $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>
         $<INSTALL_INTERFACE:include>
  PRIVATE ${CMAKE_CURRENT_SOURCE_DIR}/src)

# 链接 Conan 依赖（假设包名为 log.c, libpng, argtable3） Conan 2.x 会自动创建对应 target（如
# log.c::log.c）
FIND_PACKAGE(log4c CONFIG REQUIRED)
FIND_PACKAGE(PNG CONFIG REQUIRED)
FIND_PACKAGE(argtable3 CONFIG REQUIRED)
FIND_PACKAGE(wavefront-parser CONFIG REQUIRED)
TARGET_LINK_LIBRARIES(${TARGET} PUBLIC log4c::log4c PNG::PNG
                                       wavefront-parser::wavefront-parser)
# argtable3::argtable3

# ================
# 可执行文件（主程序）
# ================
IF(BUILD_EXAMPLES)
  ADD_SUBDIRECTORY(examples)
ENDIF()

# ================
# 安装规则（关键！用于 conan package）
# ================
INCLUDE(GNUInstallDirs)

INSTALL(FILES include/raytracer.h include/config.h
        DESTINATION ${CMAKE_INSTALL_INCLUDEDIR})

# 安装库文件
INSTALL(
  TARGETS ${TARGET}
  EXPORT raytracer-c-targets
  LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}
  ARCHIVE DESTINATION ${CMAKE_INSTALL_LIBDIR}
  RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR} # Windows DLL
)

# 安装可执行文件（如果构建）
IF(BUILD_EXECUTABLE)
  INSTALL(TARGETS raytracer DESTINATION ${CMAKE_INSTALL_BINDIR})
ENDIF()

# 安装 CMake 配置文件（用于 find_package）
INSTALL(
  EXPORT raytracer-c-targets
  FILE raytracer-c-config.cmake
  NAMESPACE raytracer-c::
  DESTINATION ${CMAKE_INSTALL_LIBDIR}/cmake/raytracer-c)
